# Ручной подбор частоты Input Shaping

## Чем плох метод из документации клиппера?

<div>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/ZFPkfZEB-XU" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>

Если коротко, то он работает далеко не всегда. Конкретно на VOSTOK'е вообще не работает. Подробнее раскрыто в видео

## Подготовка тестируемого принтера

Перед подбором частоты рекомендуется проверить механику принтера. Убедитесь, что все винты закручены, что все детали на печатающей голове закреплены достаточно жестко, что ремни нормально натянуты (не недотянуты, но и не перетянуты) и т.д. В случае, если вы собираетесь вносить какие-то изменения в механику принтера, то лучше внести их до подбора частоты, так как изменение массы и конфигурации движущихся частей приведут к необходимости проводить калибровку заново.

## Подготовка тестового g-code

1. Скачайте тестовую модель: [:material-printer-3d-nozzle: ringing_tower.stl](https://www.klipper3d.org/prints/ringing_tower.stl)

2. Откройте её в любом слайсере

3. Нарежьте со следующими параметрами:
   
   1. В качестве пластика следует использовать любой простой в печати, желательно тёмного цвета, чтобы эхо было различимо
   
   2. Крышку и дно выключить (0 слоёв)
   
   3. Заполнение выключить (0% плотность)
   
   4. Кайма около 5 мм, чтобы модель не отрывало при печати
   
   5. Заполнение зазоров выключить (если есть)
   
   6. Скорости и ускорения всех линий предельные для принтера

4. Загрузите в Klipper, но не запускайте печать

## Подбор частоты шейпера оси Y

### Подготовка печати

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv SHAPER_FREQ_X=0`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_Y START=30 STEP_DELTA=5 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

### Интерпретация модели

![is_cali_model_y.jpg](./pics/is_cali_model_y.jpg)

На получившейся модели каждый сегмент печатается с разной частотой шейпера на ось Y. На нижнем сегменте частота равна таковой из аргумента `START` в предыдущей команде. Каждый следующий сегмент печатается с чатотой на `STEP_DELTA` больше, чем предыдущий.

Осмотрите модель со всех сторон. Не обращайте внимание ни на какие дефекты, кроме эхо после поворотов. Выберите частоту, на которой эхо меньше всего <u>на всей модели</u>. Если таковых частот несколько, то выберите среднее значение. Это и есть частота шейпера на ось Y в первом приближении.

## Подбор частоты шейпера оси X

### Подготовка печати

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y={значение из предыдущей калибровки}`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_X START=40 STEP_DELTA=10 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

### Интерпретация модели

На получившейся модели на оси Y действует шейпер `mzv` с частотой, подобранной ранее. На оси X частота шейпера меняется начиная со значения аргумента `START` с шагом `STEP_DELTA`.

Осмотрите модель со всех сторон. Не обращайте внимание ни на какие дефекты, кроме эхо после поворотов. Выберите частоту, на которой эхо меньше всего <u>на всей модели</u>. Если таких значений несколько, то выберите среднее. Это и есть частота шейпера на ось X в первом приближении.

## Проверочная печать

```py
[input_shaper]
shaper_type_x = mzv
shaper_freq_x = {значение для оси Х}
shaper_type_y = mzv
shaper_freq_y = {значение для оси Y}
```

1. Добавьте в printer.cfg блок кода сверху. Обратите внимание, что частоты вводятся без фигурных скобок

2. Сохраните изменения и сделайте `FIRMWARE_RESTART`

3. Скачайте любую тестовую модель с большим количеством поворотов: 
   
   1. [:material-printer-3d-nozzle: Лис](./models/fox.stl) (печатать лучше в масштабе 50%)
   
   2. [:material-printer-3d-nozzle: Кот](./models/calicat.stl)
   
   3. [:material-printer-3d-nozzle: Кубик](./models/test_cube.stl)

4. Распечатайте с обычными для себя с желаемыми параметрами скоростей и ускорений. Если качество печати вас устраивает, то подбор частот закончен.

---

## Вторая итерация калибровки

В случае, если первая итерация калибровки не дала нужного результата, стоит провести вторую для исключения неправильного подбора частот. В целом, она делается так же, только начинается не с выключения шейпера на ось Х, а с установки значения из первой итерации калибровки.

### Подбор частоты шейпера оси Y

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv SHAPER_FREQ_X={значение из предыдущей калибровки}`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_Y START=30 STEP_DELTA=5 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

4. Интерпретируйте как раньше

### Подбор частоты шейпера оси X

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y={значение из предыдущей калибровки}`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_X START=40 STEP_DELTA=10 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

4. Интерпретируйте как раньше

5. Сохраните параметры и сделайте `FIRMWARE_RESTART`

6. Сделайте проверочную печать

---

## Уточненный подбор частот

Если две итерации подбора сильно уменьшили эхо, но не исключили полностью, то можно подобрать частоты более точно. Для этого проводится еще одна итерация, только с другими значениями атрибутов `START` и `STEP_DELTA`.

### Подбор частоты шейпера оси Y

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv SHAPER_FREQ_X={значение из предыдущей калибровки}`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_Y START={значение из предыдущей итерации минус 10} STEP_DELTA=2 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

4. Интерпретируйте как раньше

### Подбор частоты шейпера оси X

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=mzv SHAPER_TYPE_Y=mzv SHAPER_FREQ_Y={значение из предыдущей калибровки}`

2. Ввидите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_X START={значение из предыдущей итерации минус 10} STEP_DELTA=2 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

4. Интерпретируйте как раньше

5. Сохраните параметры и сделайте `FIRMWARE_RESTART`

6. Сделайте проверочную печать

---

## Подбор типа шейпера

В случае, если предыдущие шаги не дали достаточно хорошего результата, следует повторить калибровку с шейперами, убирающими вибрации в более широком спектре частот. Градация по ширине спектра: `zv < mzv < ei < 2hump_ei < 3hump_ei`. При этом шейпер `zv` является слишком узким и практически никогда не даёт нормального результата. Поэтому с ним можно даже не пробовать. 

`ei`, хоть формально шире, чем `mzv`, но совсем немного. Так что для него не имеет большого смысла заново проводить калибровку, можно просто поставить вместо `mzv` с теми же частотами в `printer.cfg` и сделать проверочную печать. 

### Тесты с 2hump_ei и 3hump_ei

Частота шейпера `mzv` с помощью предыдущих методик подбирается так, чтобы загасить вибрации на какой-то одной частоте и немного вокруг неё. В случае, если вибрации происходят на двух, трёх и т.д. разных частотах, то применяются шейперы `2hump_ei` или даже `3hump_ei`, которые гасят очень широкий спектр частот. Ввиду этого не имеет большого смысла проверять их работу на частотах ниже 50 Гц, так как они будут захвачены работой шейпера на 50 Гц. Также не имеет смысла подбирать частоту с точностью до 1-5 Гц, точности до 10 Гц хватит для нормальной работы шейпера.

### Подбор частоты шейпера 2hump_ei для оси Y

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=2hump_ei SHAPER_TYPE_Y=2hump_ei SHAPER_FREQ_X=0`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_Y START=50 STEP_DELTA=10 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

4. Интерпретируйте как раньше, но с одним изменением. Если результат вас устраивает на каком-то спектре частот, то выбирайте не среднее, а максимальное значение, чтобы избежать излишнего скругления углов

### Подбор частоты шейпера 2hump_ei для оси Х

1. Введите команду `SET_INPUT_SHAPER SHAPER_TYPE_X=2hump_ei SHAPER_TYPE_Y=2hump_ei SHAPER_FREQ_Y={значение из предыдущего шага}`

2. Введите команду `TUNING_TOWER COMMAND=SET_INPUT_SHAPER PARAMETER=SHAPER_FREQ_X START=50 STEP_DELTA=10 STEP_HEIGHT=5`

3. Запустите печать ранее нарезанной модели

4. Интерпретируйте как раньше, но с одним изменением. Если результат вас устраивает на каком-то спектре частот, то выбирайте не среднее, а максимальное значение, чтобы избежать излишнего скругления углов

5. Сохраните параметры и сделайте `FIRMWARE_RESTART`

6. Сделайте проверочную печать

### Последний шанс

Если на проверочной модели всё еще остаются значимые вибрации, то повторите подбор для `2hump_ei`, но с шейпером `3hump_ei`. Если и так не получается добиться хорошего результата, то у вашего принтера явно сильные проблемы с механикой. Попробуйте закрепить всё, что может шататься на печатающей голове и балке, увеличить жесткость рамы, заменить ремни на более жёсткие (например, на более широкие) и т.д.

---

## Подбор максимальных ускорений печати

После включения инпут шейпинга, появится новый дефект печати - скругление углов. Этот дефект имеет не постоянную природу, и проявляется тем сильнее, чем более жесткий шейпер включен, чем ниже его частота и чем выше скорости и ускорения печати. В свою очередь это означает, что нет и не может существовать одного значения ускорения или скорости, на котором следует печатать все модели. А, значит, не может существовать и методики подбора такого ускорения. Вы должны просто попечатать модели на разных скоростях и ускорениях и понять на каких режимах насколько сильно скругляются углы. После этого вам и без специальных методик станет ясно какие скоростные режимы стоит ставить для наилучшей детализации, какие пригодны для печати технических моделей, а какие не пригодны для печати вообще. 

```
Дата: 22.04.2022
Автор: Дмитрий Соркин
Telegram: @dmitry_sorkin
E-mail: dbsorkin@gmail.com
```
